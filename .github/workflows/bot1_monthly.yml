name: Bot 1 - Buscar V√≠deos (Mensal)

on:
  schedule:
    - cron: '0 0 1 * *'  # Dia 1 de cada m√™s √† meia-noite
  workflow_dispatch:  # Permite execu√ß√£o manual

permissions:
  contents: write

jobs:
  buscar-videos:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout reposit√≥rio
      uses: actions/checkout@v4
      
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Instalar yt-dlp
      run: |
        pip install yt-dlp
        
    - name: Buscar v√≠deos no YouTube
      run: |
        python3 << 'EOF'
        import yt_dlp
        import json
        import random

        print("üîç Iniciando busca de v√≠deos no YouTube...")
        
        # Ler lista de artistas
        with open('artistas.txt', 'r', encoding='utf-8') as f:
            artistas = [linha.strip() for linha in f if linha.strip()]
        
        videos_encontrados = []
        
        for artista in artistas:
            print(f"\nüéµ Buscando: {artista}")
            
            ydl_opts = {
                'quiet': True,
                'no_warnings': True,
                'extract_flat': True,
            }
            
            try:
                with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                    resultado = ydl.extract_info(f"ytsearch5:{artista} official video", download=False)
                    
                    if 'entries' in resultado:
                        for video in resultado['entries']:
                            if video:
                                url = f"https://www.youtube.com/watch?v={video['id']}"
                                titulo = video.get('title', 'Sem t√≠tulo')
                                duracao = video.get('duration', 0)
                                
                                # Filtrar: entre 90s e 8min (480s)
                                if 90 <= duracao <= 480:
                                    videos_encontrados.append({
                                        'artista': artista,
                                        'titulo': titulo,
                                        'url': url,
                                        'duracao': duracao,
                                        'processado': False
                                    })
                                    print(f"  ‚úÖ {titulo} ({duracao}s)")
                                    
                                    # Limitar a 150 v√≠deos no total
                                    if len(videos_encontrados) >= 150:
                                        break
                        
                if len(videos_encontrados) >= 150:
                    break
                    
            except Exception as e:
                print(f"  ‚ùå Erro ao buscar {artista}: {e}")
        
        # Embaralhar para variedade
        random.shuffle(videos_encontrados)
        
        # Salvar lista
        with open('videos_lista.json', 'w', encoding='utf-8') as f:
            json.dump(videos_encontrados, f, indent=2, ensure_ascii=False)
        
        print(f"\n‚úÖ Total de v√≠deos encontrados: {len(videos_encontrados)}")
        print("üìÑ Lista salva em: videos_lista.json")
        EOF
        
    - name: Commit da lista de v√≠deos
      run: |
        git config --local user.email "bot@github.com"
        git config --local user.name "Flashback Bot"
        git add videos_lista.json
        git commit -m "üé¨ Lista de v√≠deos atualizada - $(date +'%Y-%m-%d')" || echo "Nenhuma mudan√ßa para commitar"
        git push
        
    - name: Notificar no Telegram
      if: always()
      env:
        BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=Bot 1 - Busca Mensal Concluida! Nova lista de videos gerada em $(date +'%d/%m/%Y %H:%M')"
