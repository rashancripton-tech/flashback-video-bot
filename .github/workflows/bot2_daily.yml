name: Bot 2 - Processar V√≠deo Di√°rio

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  processar-video:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install -U yt-dlp requests
      
      - name: Processar v√≠deo
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PROXY_LIST: ${{ secrets.PROXY_LIST }}
        run: |
          python3 << 'EOF'
          import yt_dlp
          import json
          import os
          import subprocess
          import requests
          import time
          import random
          from datetime import datetime

          print("üé¨ Iniciando processamento de v√≠deo...")

          if not os.path.exists('videos_lista.json'):
              print("‚ùå Arquivo videos_lista.json n√£o encontrado!")
              exit(1)

          with open('videos_lista.json', 'r', encoding='utf-8') as f:
              videos = json.load(f)

          video_atual = None
          for video in videos:
              if not video.get('processado', False):
                  video_atual = video
                  break

          if not video_atual:
              print("‚úÖ Todos os v√≠deos j√° foram processados!")
              exit(0)

          print(f"\nüìπ Processando: {video_atual['titulo']}")
          print(f"üé§ Artista: {video_atual['artista']}")
          print(f"üîó URL: {video_atual['url']}")

          # Carregar lista de proxies
          proxy_list_str = os.environ.get('PROXY_LIST', '')
          proxy_list = [p.strip() for p in proxy_list_str.split(',') if p.strip()]
          
          if proxy_list:
              print(f"\nüåê {len(proxy_list)} proxies dispon√≠veis para rota√ß√£o")
          else:
              print("\n‚ö†Ô∏è Nenhum proxy configurado - usando conex√£o direta")
              proxy_list = [None]

          # Delay aleat√≥rio inicial
          delay_inicial = random.randint(3, 8)
          print(f"\n‚è±Ô∏è Aguardando {delay_inicial}s (comportamento humano)...")
          time.sleep(delay_inicial)

          print("\n‚¨áÔ∏è Tentando baixar v√≠deo do YouTube...")
          
          sucesso_download = False
          proxy_usado = None
          
          # Tentar cada proxy da lista
          for idx, proxy in enumerate(proxy_list, 1):
              if sucesso_download:
                  break
                  
              proxy_display = proxy.split('@')[0] if proxy and '@' in proxy else (proxy.split('//')[1].split(':')[0] if proxy else "Conex√£o Direta")
              print(f"\nüì° Tentativa {idx}/{len(proxy_list)}: {proxy_display}")
              
              ydl_opts = {
                  'format': 'best[height<=720][ext=mp4]/best[height<=720]/best',
                  'outtmpl': 'video_original.%(ext)s',
                  'quiet': True,
                  'no_warnings': True,
                  'socket_timeout': 30,
                  'retries': 3,
                  'fragment_retries': 3,
                  'file_access_retries': 2,
                  'extractor_retries': 2,
                  'sleep_interval': 5,
                  'max_sleep_interval': 10,
                  'extractor_args': {
                      'youtube': {
                          'player_client': ['ios', 'android', 'web'],
                          'skip': ['hls', 'dash']
                      }
                  },
                  'http_headers': {
                      'User-Agent': 'com.google.ios.youtube/19.29.1 (iPhone16,2; U; CPU iOS 17_5_1 like Mac OS X;)',
                      'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
                  }
              }

              if proxy:
                  ydl_opts['proxy'] = proxy

              try:
                  with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                      ydl.download([video_atual['url']])
                  
                  print(f"   ‚úÖ Download conclu√≠do com sucesso!")
                  sucesso_download = True
                  proxy_usado = proxy_display
                  
              except Exception as e:
                  erro_msg = str(e)[:150]
                  print(f"   ‚ùå Falhou: {erro_msg}")
                  
                  # Se n√£o for o √∫ltimo proxy, aguarda um pouco antes de tentar o pr√≥ximo
                  if idx < len(proxy_list):
                      delay = random.randint(5, 10)
                      print(f"   ‚è≥ Aguardando {delay}s antes do pr√≥ximo proxy...")
                      time.sleep(delay)

          if not sucesso_download:
              print(f"\n‚ùå Todos os {len(proxy_list)} proxies falharam!")
              video_atual['processado'] = True
              video_atual['erro'] = f"Falha em todos os {len(proxy_list)} proxies"
              video_atual['data_processamento'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
              
              with open('videos_lista.json', 'w', encoding='utf-8') as f:
                  json.dump(videos, f, indent=2, ensure_ascii=False)
              
              exit(1)

          # Delay p√≥s-download
          delay_pos = random.randint(2, 5)
          print(f"\n‚è±Ô∏è Pausa de {delay_pos}s...")
          time.sleep(delay_pos)

          print("\nüé® Convertendo para formato vertical (9:16)...")
          
          cmd = [
              'ffmpeg', '-i', 'video_original.mp4',
              '-ss', '30', '-t', '90',
              '-vf', 'scale=1080:1920:force_original_aspect_ratio=increase,crop=1080:1920,fps=30',
              '-c:v', 'libx264', '-preset', 'medium', '-crf', '23',
              '-c:a', 'aac', '-b:a', '128k', '-ar', '44100',
              '-movflags', '+faststart', '-y', 'video_vertical.mp4'
          ]

          try:
              subprocess.run(cmd, check=True, capture_output=True, text=True)
              print("‚úÖ Convers√£o conclu√≠da!")
          except subprocess.CalledProcessError as e:
              print(f"‚ùå Erro na convers√£o: {e.stderr[:200]}")
              exit(1)

          print("\nüì§ Enviando para Telegram...")
          
          telegram_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          caption = f"üéµ {video_atual['titulo']}\n\nüé§ {video_atual['artista']}\n\nüé¨ Flashback Video Bot\nüåê Proxy: {proxy_usado}"
          
          try:
              with open('video_vertical.mp4', 'rb') as video_file:
                  files = {'video': video_file}
                  data = {
                      'chat_id': chat_id,
                      'caption': caption,
                      'supports_streaming': True
                  }
                  response = requests.post(
                      f"https://api.telegram.org/bot{telegram_token}/sendVideo",
                      files=files, data=data, timeout=300
                  )
                  
              if response.status_code == 200:
                  print("‚úÖ V√≠deo enviado com sucesso!")
              else:
                  print(f"‚ö†Ô∏è Resposta da API: {response.text[:200]}")
                  
          except Exception as e:
              print(f"‚ùå Erro ao enviar: {str(e)[:200]}")
              exit(1)

          video_atual['processado'] = True
          video_atual['data_processamento'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
          video_atual['proxy_usado'] = proxy_usado
          
          with open('videos_lista.json', 'w', encoding='utf-8') as f:
              json.dump(videos, f, indent=2, ensure_ascii=False)

          restantes = sum(1 for v in videos if not v.get('processado', False))
          print(f"\n‚úÖ Processamento conclu√≠do!")
          print(f"üìä V√≠deos restantes: {restantes}")
          print(f"üåê Proxy que funcionou: {proxy_usado}")
          EOF
      
      - name: Commit da lista atualizada
        if: always()
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "Flashback Bot"
          git add videos_lista.json
          git diff --staged --quiet || git commit -m "‚úÖ V√≠deo processado - $(date '+%Y-%m-%d %H:%M')"
          git push
      
      - name: Notificar sucesso
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="‚úÖ Bot 2 - V√≠deo Processado!

          üé¨ Novo v√≠deo enviado com sucesso
          üìÖ $(date '+%d/%m/%Y %H:%M')
          
          üîÑ Pr√≥ximo v√≠deo amanh√£ √†s 12h"
      
      - name: Notificar erro
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="‚ùå Todos os proxies falharam!

          üìÖ $(date '+%d/%m/%Y %H:%M')
          
          üîÑ Atualize a lista de proxies em Settings ‚Üí Secrets
          
          Logs: https://github.com/${{ github.repository }}/actions"
