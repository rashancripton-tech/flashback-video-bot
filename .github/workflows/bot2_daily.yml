name: Bot 2 - Processar V√≠deo (Di√°rio)

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  processar-video:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
        
      - name: Setup Cloudflare WARP
        uses: fscarmen/warp-sh@main
        
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Instalar depend√™ncias
        run: |
          pip install yt-dlp
          sudo apt-get update
          sudo apt-get install -y ffmpeg
        
      - name: Processar v√≠deo
        run: |
          python3 << 'EOF'
          import yt_dlp
          import json
          import subprocess
          import os
          import sys
          
          print("üé¨ Iniciando processamento com Cloudflare WARP...")
          
          if not os.path.exists('videos_lista.json'):
              print("‚ùå videos_lista.json n√£o encontrado!")
              sys.exit(1)
          
          with open('videos_lista.json', 'r', encoding='utf-8') as f:
              videos = json.load(f)
          
          video = None
          for v in videos:
              if not v.get('processado', False):
                  video = v
                  break
          
          if not video:
              print("‚úÖ Todos processados!")
              sys.exit(0)
          
          print(f"\nüìπ Selecionado:")
          print(f"   {video['artista']} - {video['titulo']}")
          
          print("\n‚¨áÔ∏è Baixando via WARP...")
          ydl_opts = {
              'format': 'bestvideo[height<=1080][ext=mp4]+bestaudio[ext=m4a]/best',
              'outtmpl': 'video_original.%(ext)s',
              'merge_output_format': 'mp4',
              'socket_timeout': 30,
          }
          
          try:
              with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                  ydl.download([video['url']])
              print("‚úÖ Download OK!")
          except Exception as e:
              print(f"‚ùå Erro: {e}")
              sys.exit(1)
          
          print("\nüîÑ Convertendo...")
          cmd = [
              'ffmpeg', '-i', 'video_original.mp4', '-t', '90',
              '-vf', 'scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:black',
              '-c:v', 'libx264', '-preset', 'fast', '-crf', '23',
              '-c:a', 'aac', '-b:a', '128k', '-y', 'video_final.mp4'
          ]
          
          subprocess.run(cmd, check=True, capture_output=True)
          print("‚úÖ Convers√£o OK!")
          
          with open('video_info.txt', 'w') as f:
              f.write(f"{video['artista']} - {video['titulo']}")
          
          video['processado'] = True
          with open('videos_lista.json', 'w', encoding='utf-8') as f:
              json.dump(videos, f, indent=2, ensure_ascii=False)
          EOF
        
      - name: Enviar para Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          INFO=$(cat video_info.txt)
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F chat_id="${CHAT_ID}" \
            -F document=@video_final.mp4 \
            -F caption="üéµ ${INFO}

üìπ 90s | 1080x1920
üé¨ Flashback Retr√¥"
        
      - name: Commit
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "Bot"
          git add videos_lista.json
          git commit -m "üìπ $(date +'%Y-%m-%d')" || echo "ok"
          git push
          
      - name: Notificar
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS=${{ job.status }}
          MSG="‚úÖ Sucesso!"
          [ "$STATUS" != "success" ] && MSG="‚ùå Erro!"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${MSG}"
