name: Bot 2 - Processar V√≠deo (Di√°rio)

on:
  schedule:
    - cron: '0 12 * * *'  # Todo dia ao meio-dia UTC (9h BRT)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  processar-video:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
        
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Instalar depend√™ncias
        run: |
          pip install yt-dlp
          sudo apt-get update
          sudo apt-get install -y ffmpeg
        
      - name: Processar v√≠deo
        id: processar
        run: |
          python3 << 'EOF'
          import yt_dlp
          import json
          import subprocess
          import os
          import sys
          
          print("üé¨ Iniciando processamento de v√≠deo...")
          
          # Verificar se existe lista de v√≠deos
          if not os.path.exists('videos_lista.json'):
              print("‚ùå Arquivo videos_lista.json n√£o encontrado!")
              print("Execute o Bot 1 primeiro para gerar a lista de v√≠deos.")
              sys.exit(1)
          
          # Ler lista de v√≠deos
          with open('videos_lista.json', 'r', encoding='utf-8') as f:
              videos = json.load(f)
          
          # Encontrar pr√≥ximo v√≠deo n√£o processado
          video = None
          for v in videos:
              if not v.get('processado', False):
                  video = v
                  break
          
          if not video:
              print("‚úÖ Todos os v√≠deos j√° foram processados!")
              sys.exit(0)
          
          print(f"\nüìπ V√≠deo selecionado:")
          print(f"   Artista: {video['artista']}")
          print(f"   T√≠tulo: {video['titulo']}")
          print(f"   Dura√ß√£o: {video['duracao']}s")
          print(f"   URL: {video['url']}")
          
          # Baixar v√≠deo
          print("\n‚¨áÔ∏è Baixando v√≠deo do YouTube...")
          ydl_opts = {
              'format': 'bestvideo[height<=1080][ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best',
              'outtmpl': 'video_original.%(ext)s',
              'merge_output_format': 'mp4',
          }
          
          try:
              with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                  ydl.download([video['url']])
              print("‚úÖ Download conclu√≠do!")
          except Exception as e:
              print(f"‚ùå Erro no download: {e}")
              sys.exit(1)
          
          # Converter para vertical 90s
          print("\nüîÑ Convertendo para formato vertical (1080x1920, 90s)...")
          comando_ffmpeg = [
              'ffmpeg',
              '-i', 'video_original.mp4',
              '-t', '90',
              '-vf', 'scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:black',
              '-c:v', 'libx264',
              '-preset', 'medium',
              '-crf', '23',
              '-c:a', 'aac',
              '-b:a', '128k',
              '-y',
              'video_final.mp4'
          ]
          
          try:
              subprocess.run(comando_ffmpeg, check=True, capture_output=True)
              print("‚úÖ Convers√£o conclu√≠da!")
          except subprocess.CalledProcessError as e:
              print(f"‚ùå Erro na convers√£o: {e}")
              sys.exit(1)
          
          # Verificar se arquivo final existe
          if not os.path.exists('video_final.mp4'):
              print("‚ùå Arquivo final n√£o foi gerado!")
              sys.exit(1)
          
          tamanho = os.path.getsize('video_final.mp4') / (1024 * 1024)
          print(f"üì¶ Tamanho do arquivo: {tamanho:.2f} MB")
          
          # Salvar informa√ß√µes para pr√≥ximos steps
          with open('video_info.txt', 'w', encoding='utf-8') as f:
              f.write(f"{video['artista']} - {video['titulo']}")
          
          # Marcar como processado
          video['processado'] = True
          with open('videos_lista.json', 'w', encoding='utf-8') as f:
              json.dump(videos, f, indent=2, ensure_ascii=False)
          
          print("\n‚úÖ V√≠deo processado com sucesso!")
          EOF
        
      - name: Enviar v√≠deo para Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          VIDEO_INFO=$(cat video_info.txt)
          
          echo "üì§ Enviando v√≠deo para Telegram..."
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F chat_id="${CHAT_ID}" \
            -F document=@video_final.mp4 \
            -F caption="üéµ ${VIDEO_INFO}

üìπ V√≠deo pronto para postar! 90 segundos | 1080x1920
üé¨ Flashback M√∫sica Retr√¥"
          
          echo "‚úÖ V√≠deo enviado!"
        
      - name: Commit da lista atualizada
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "Flashback Bot"
          git add videos_lista.json
          git commit -m "üìπ V√≠deo processado - $(date +'%Y-%m-%d')" || echo "Nenhuma mudanca"
          git push
          
      - name: Notificar conclus√£o
        if: success()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          VIDEO_INFO=$(cat video_info.txt)
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=‚úÖ Processamento conclu√≠do!

üìπ ${VIDEO_INFO}

V√≠deo enviado acima!"
          
      - name: Notificar erro
        if: failure()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=‚ùå Erro no processamento!

Verifique os logs em: https://github.com/${{ github.repository }}/actions"
