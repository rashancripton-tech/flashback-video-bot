name: Bot 2 - Processar V√≠deo Di√°rio

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  processar-video:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install -U yt-dlp requests
      
      - name: Processar v√≠deo
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PROXY_URL: ${{ secrets.PROXY_URL }}
        run: |
          python3 << 'EOF'
          import yt_dlp
          import json
          import os
          import subprocess
          import requests
          import time
          import random
          from datetime import datetime

          print("üé¨ Iniciando processamento de v√≠deo...")

          if not os.path.exists('videos_lista.json'):
              print("‚ùå Arquivo videos_lista.json n√£o encontrado!")
              exit(1)

          with open('videos_lista.json', 'r', encoding='utf-8') as f:
              videos = json.load(f)

          video_atual = None
          for video in videos:
              if not video.get('processado', False):
                  video_atual = video
                  break

          if not video_atual:
              print("‚úÖ Todos os v√≠deos j√° foram processados!")
              exit(0)

          print(f"\nüìπ Processando: {video_atual['titulo']}")
          print(f"üé§ Artista: {video_atual['artista']}")
          print(f"üîó URL: {video_atual['url']}")

          # Configurar proxy rotativo
          proxy_url = os.environ.get('PROXY_URL')
          
          if proxy_url:
              print(f"\nüåê Usando proxy rotativo: {proxy_url.split('@')[0] if '@' in proxy_url else proxy_url.split('//')[1].split(':')[0]}")
          else:
              print("\n‚ö†Ô∏è Nenhum proxy configurado - usando IP direto")

          # Delay aleat√≥rio inicial (simula comportamento humano)
          delay_inicial = random.randint(3, 8)
          print(f"\n‚è±Ô∏è Aguardando {delay_inicial}s (comportamento humano)...")
          time.sleep(delay_inicial)

          print("\n‚¨áÔ∏è Baixando v√≠deo do YouTube...")
          
          ydl_opts = {
              'format': 'best[height<=720][ext=mp4]/best[height<=720]/best',
              'outtmpl': 'video_original.%(ext)s',
              'quiet': True,
              'no_warnings': True,
              'socket_timeout': 60,
              'retries': 10,
              'fragment_retries': 10,
              'file_access_retries': 5,
              'extractor_retries': 5,
              'sleep_interval': 5,
              'max_sleep_interval': 15,
              'sleep_interval_subtitles': 5,
              'extractor_args': {
                  'youtube': {
                      'player_client': ['ios', 'android', 'web'],
                      'skip': ['hls', 'dash']
                  }
              },
              'http_headers': {
                  'User-Agent': 'com.google.ios.youtube/19.29.1 (iPhone16,2; U; CPU iOS 17_5_1 like Mac OS X;)',
                  'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
              }
          }

          # Adicionar proxy se dispon√≠vel
          if proxy_url:
              ydl_opts['proxy'] = proxy_url

          tentativas = 0
          max_tentativas = 3
          sucesso = False

          while tentativas < max_tentativas and not sucesso:
              tentativas += 1
              try:
                  print(f"   üì• Tentativa {tentativas}/{max_tentativas}...")
                  
                  # Delay entre tentativas (exceto primeira)
                  if tentativas > 1:
                      delay = random.randint(10, 20)
                      print(f"   ‚è≥ Aguardando {delay}s antes de tentar novamente...")
                      time.sleep(delay)
                  
                  with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                      ydl.download([video_atual['url']])
                  
                  print("‚úÖ Download conclu√≠do!")
                  sucesso = True
                  
              except Exception as e:
                  erro_msg = str(e)
                  print(f"   ‚ö†Ô∏è Erro: {erro_msg[:150]}")
                  
                  if tentativas >= max_tentativas:
                      print(f"‚ùå Falhou ap√≥s {max_tentativas} tentativas")
                      video_atual['processado'] = True
                      video_atual['erro'] = erro_msg[:300]
                      video_atual['data_processamento'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                      with open('videos_lista.json', 'w', encoding='utf-8') as f:
                          json.dump(videos, f, indent=2, ensure_ascii=False)
                      
                      # Notificar erro espec√≠fico
                      if 'bot' in erro_msg.lower():
                          print("\n‚ö†Ô∏è Detectado como bot - proxy pode precisar rota√ß√£o")
                      
                      exit(1)

          # Delay antes da convers√£o (simula humano assistindo)
          delay_pos = random.randint(2, 5)
          print(f"\n‚è±Ô∏è Pausa de {delay_pos}s...")
          time.sleep(delay_pos)

          print("\nüé® Convertendo para formato vertical (9:16)...")
          
          cmd = [
              'ffmpeg', '-i', 'video_original.mp4',
              '-ss', '30', '-t', '90',
              '-vf', 'scale=1080:1920:force_original_aspect_ratio=increase,crop=1080:1920,fps=30',
              '-c:v', 'libx264', '-preset', 'medium', '-crf', '23',
              '-c:a', 'aac', '-b:a', '128k', '-ar', '44100',
              '-movflags', '+faststart', '-y', 'video_vertical.mp4'
          ]

          try:
              subprocess.run(cmd, check=True, capture_output=True, text=True)
              print("‚úÖ Convers√£o conclu√≠da!")
          except subprocess.CalledProcessError as e:
              print(f"‚ùå Erro na convers√£o: {e.stderr[:200]}")
              exit(1)

          print("\nüì§ Enviando para Telegram...")
          
          telegram_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          caption = f"üéµ {video_atual['titulo']}\n\nüé§ {video_atual['artista']}\n\nüé¨ Flashback Video Bot"
          
          try:
              with open('video_vertical.mp4', 'rb') as video_file:
                  files = {'video': video_file}
                  data = {
                      'chat_id': chat_id,
                      'caption': caption,
                      'supports_streaming': True
                  }
                  response = requests.post(
                      f"https://api.telegram.org/bot{telegram_token}/sendVideo",
                      files=files, data=data, timeout=300
                  )
                  
              if response.status_code == 200:
                  print("‚úÖ V√≠deo enviado com sucesso!")
              else:
                  print(f"‚ö†Ô∏è Resposta da API: {response.text[:200]}")
                  
          except Exception as e:
              print(f"‚ùå Erro ao enviar: {str(e)[:200]}")
              exit(1)

          video_atual['processado'] = True
          video_atual['data_processamento'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
          
          with open('videos_lista.json', 'w', encoding='utf-8') as f:
              json.dump(videos, f, indent=2, ensure_ascii=False)

          restantes = sum(1 for v in videos if not v.get('processado', False))
          print(f"\n‚úÖ Processamento conclu√≠do!")
          print(f"üìä V√≠deos restantes: {restantes}")
          EOF
      
      - name: Commit da lista atualizada
        if: always()
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "Flashback Bot"
          git add videos_lista.json
          git diff --staged --quiet || git commit -m "‚úÖ V√≠deo processado - $(date '+%Y-%m-%d %H:%M')"
          git push
      
      - name: Notificar sucesso
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="‚úÖ Bot 2 - V√≠deo Processado!

          üé¨ Novo v√≠deo enviado com sucesso
          üìÖ $(date '+%d/%m/%Y %H:%M')
          
          üîÑ Pr√≥ximo v√≠deo amanh√£ √†s 12h"
      
      - name: Notificar erro
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="‚ùå Erro no processamento!

          üìÖ $(date '+%d/%m/%Y %H:%M')
          
          üîç Verifique se o proxy precisa ser atualizado
          
          Logs: https://github.com/${{ github.repository }}/actions"
