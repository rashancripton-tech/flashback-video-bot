name: Bot 2 - Processar V√≠deo Di√°rio

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  processar-video:
    runs-on: ubuntu-latest  # ‚úÖ Voltamos para latest - n√£o precisa mais de 22.04
    
    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
      
      # ‚ùå REMOVEMOS O WARP - N√£o funciona bem no GitHub Actions
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Instalar depend√™ncias
        run: |
          pip install yt-dlp requests
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Processar v√≠deo
        id: processar
        run: |
          python3 << 'EOF'
          import yt_dlp
          import json
          import subprocess
          import os
          import sys

          print("üé¨ Iniciando processamento de v√≠deo...")

          # Verificar se existe lista de v√≠deos
          if not os.path.exists('videos-lista.json'):
              print("‚ùå Arquivo videos-lista.json n√£o encontrado!")
              print("‚ö†Ô∏è Execute o Bot 1 primeiro para gerar a lista de v√≠deos.")
              sys.exit(1)

          # Ler lista de v√≠deos
          with open('videos-lista.json', 'r', encoding='utf-8') as f:
              videos = json.load(f)

          # Encontrar pr√≥ximo v√≠deo n√£o processado
          video = None
          for v in videos:
              if not v.get('processado', False):
                  video = v
                  break

          if not video:
              print("‚úÖ N√£o h√° v√≠deos pendentes!")
              sys.exit(0)

          print(f"\nüìπ V√≠deo selecionado:")
          print(f"   üé§ Artista: {video['artista']}")
          print(f"   üéµ T√≠tulo: {video['titulo']}")
          print(f"   ‚è±Ô∏è Dura√ß√£o: {video['duracao']}s")
          print(f"   üîó URL: {video['url']}")

          # ‚úÖ CONFIGURA√á√ÉO COM USER-AGENT SPOOFING
          print("\n‚¨áÔ∏è Baixando v√≠deo do YouTube (com bypass)...")
          ydl_opts = {
              'format': 'bestvideo[height<=1080][ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best',
              'outtmpl': 'video-original.%(ext)s',
              'merge_output_format': 'mp4',
              # üî• USER-AGENT PERSONALIZADO - Simula navegador real
              'user_agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              # üî• FOR√áA CLIENTE ANDROID - YouTube n√£o bloqueia
              'extractor_args': {
                  'youtube': {
                      'player_client': ['android', 'web'],
                      'skip': ['hls', 'dash']
                  }
              },
              # üî• HEADERS EXTRAS para parecer navegador real
              'http_headers': {
                  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                  'Accept-Language': 'en-us,en;q=0.5',
                  'Sec-Fetch-Mode': 'navigate',
              },
              'quiet': False,
              'no_warnings': False,
          }

          try:
              with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                  ydl.download([video['url']])
              print("‚úÖ Download conclu√≠do!")
          except Exception as e:
              print(f"‚ùå Erro no download: {e}")
              sys.exit(1)

          # Verificar se arquivo foi baixado
          if not os.path.exists('video-original.mp4'):
              print("‚ùå Arquivo de v√≠deo n√£o foi baixado!")
              sys.exit(1)

          # Converter para vertical 90s
          print("\nüé® Convertendo para formato vertical (1080x1920, 90s)...")
          comando_ffmpeg = [
              'ffmpeg',
              '-i', 'video-original.mp4',
              '-t', '90',
              '-vf', 'scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:black',
              '-c:v', 'libx264',
              '-preset', 'medium',
              '-crf', '23',
              '-c:a', 'aac',
              '-b:a', '128k',
              '-y',
              'video-final.mp4'
          ]

          try:
              resultado = subprocess.run(comando_ffmpeg, check=True, capture_output=True, text=True)
              print("‚úÖ Convers√£o conclu√≠da!")
          except subprocess.CalledProcessError as e:
              print(f"‚ùå Erro na convers√£o: {e}")
              print(f"Stderr: {e.stderr}")
              sys.exit(1)

          # Verificar se arquivo final existe
          if not os.path.exists('video-final.mp4'):
              print("‚ùå Arquivo final n√£o foi gerado!")
              sys.exit(1)

          # Informa√ß√µes do arquivo
          tamanho = os.path.getsize('video-final.mp4') / (1024 * 1024)
          print(f"\nüì¶ Tamanho do arquivo: {tamanho:.2f} MB")

          # Salvar informa√ß√µes para pr√≥ximos steps
          with open('video-info.txt', 'w', encoding='utf-8') as f:
              f.write(f"üéµ {video['artista']} - {video['titulo']}")

          # Marcar como processado
          video['processado'] = True

          with open('videos-lista.json', 'w', encoding='utf-8') as f:
              json.dump(videos, f, indent=2, ensure_ascii=False)

          print("\n‚úÖ V√≠deo processado com sucesso!")
          EOF
      
      - name: Enviar v√≠deo para Telegram
        run: |
          VIDEO_INFO=$(cat video-info.txt)
          echo "üì§ Enviando para Telegram: $VIDEO_INFO"
          
          curl -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
               -F document=@video-final.mp4 \
               -F caption="$VIDEO_INFO
          
          ‚è±Ô∏è 90 segundos | üìê 1080x1920
          üé∏ Flashback - M√∫sica Retr√¥
          ü§ñ Bot Autom√°tico" \
               https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument
      
      - name: Commit da lista atualizada
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "Flashback Bot"
          git add videos-lista.json
          git commit -m "‚úÖ V√≠deo processado - $(date '+%Y-%m-%d %H:%M')" || echo "Nenhuma mudan√ßa"
          git push
      
      - name: Notificar conclus√£o
        if: success()
        run: |
          VIDEO_INFO=$(cat video-info.txt)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="‚úÖ Processamento conclu√≠do!

          $VIDEO_INFO
          üìÖ $(date '+%d/%m/%Y %H:%M')

          üé• V√≠deo enviado acima!
          üöÄ Bot rodando sem VPN!"
      
      - name: Notificar erro
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="‚ùå Erro no processamento!

          üìÖ $(date '+%d/%m/%Y %H:%M')

          üîç Verifique os logs: https://github.com/${{ github.repository }}/actions"
