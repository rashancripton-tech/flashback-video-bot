name: Bot 2 - Processar V√≠deo Di√°rio

on:
  schedule:
    - cron: '0 12 * * *'  # Todo dia √†s 12h UTC
  workflow_dispatch:  # Permite execu√ß√£o manual

permissions:
  contents: write

jobs:
  processar-video:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install yt-dlp requests
      
      - name: Processar v√≠deo
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 << 'EOF'
          import yt_dlp
          import json
          import os
          import subprocess
          import requests
          from datetime import datetime

          print("üé¨ Iniciando processamento de v√≠deo...")

          # Verificar se o arquivo existe
          if not os.path.exists('videos-lista.json'):
              print("‚ùå Arquivo videos-lista.json n√£o encontrado!")
              print("‚ö†Ô∏è Execute o Bot 1 primeiro para gerar a lista de v√≠deos.")
              exit(1)

          # Carregar lista de v√≠deos
          with open('videos-lista.json', 'r', encoding='utf-8') as f:
              videos = json.load(f)

          # Encontrar primeiro v√≠deo n√£o processado
          video_atual = None
          for video in videos:
              if not video.get('processado', False):
                  video_atual = video
                  break

          if not video_atual:
              print("‚úÖ Todos os v√≠deos j√° foram processados!")
              print("üí° Execute o Bot 1 novamente para gerar nova lista.")
              exit(0)

          print(f"\nüìπ Processando: {video_atual['titulo']}")
          print(f"üé§ Artista: {video_atual['artista']}")
          print(f"üîó URL: {video_atual['url']}")

          # Baixar v√≠deo
          print("\n‚¨áÔ∏è Baixando v√≠deo do YouTube...")
          ydl_opts = {
              'format': 'bestvideo[height<=720][ext=mp4]+bestaudio[ext=m4a]/best[height<=720][ext=mp4]/best',
              'outtmpl': 'video_original.%(ext)s',
              'quiet': False,
              'no_warnings': False,
          }

          try:
              with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                  ydl.download([video_atual['url']])
              print("‚úÖ Download conclu√≠do!")
          except Exception as e:
              print(f"‚ùå Erro ao baixar v√≠deo: {e}")
              exit(1)

          # Converter para vertical 90s
          print("\nüé® Convertendo para formato vertical (9:16) - 90 segundos...")
          
          cmd = [
              'ffmpeg',
              '-i', 'video_original.mp4',
              '-ss', '30',  # Come√ßa aos 30s
              '-t', '90',   # Dura√ß√£o de 90s
              '-vf', 'scale=1080:1920:force_original_aspect_ratio=increase,crop=1080:1920,fps=30',
              '-c:v', 'libx264',
              '-preset', 'medium',
              '-crf', '23',
              '-c:a', 'aac',
              '-b:a', '128k',
              '-ar', '44100',
              '-movflags', '+faststart',
              '-y',
              'video_vertical.mp4'
          ]

          try:
              subprocess.run(cmd, check=True, capture_output=True, text=True)
              print("‚úÖ Convers√£o conclu√≠da!")
          except subprocess.CalledProcessError as e:
              print(f"‚ùå Erro na convers√£o: {e.stderr}")
              exit(1)

          # Enviar para Telegram
          print("\nüì§ Enviando para Telegram...")
          
          telegram_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          
          caption = f"üéµ {video_atual['titulo']}\n\nüé§ {video_atual['artista']}\n\nüé¨ Flashback Video Bot"
          
          url = f"https://api.telegram.org/bot{telegram_token}/sendVideo"
          
          try:
              with open('video_vertical.mp4', 'rb') as video_file:
                  files = {'video': video_file}
                  data = {
                      'chat_id': chat_id,
                      'caption': caption,
                      'supports_streaming': True
                  }
                  response = requests.post(url, files=files, data=data, timeout=300)
                  
              if response.status_code == 200:
                  print("‚úÖ V√≠deo enviado com sucesso!")
              else:
                  print(f"‚ö†Ô∏è Resposta da API: {response.text}")
                  
          except Exception as e:
              print(f"‚ùå Erro ao enviar para Telegram: {e}")
              exit(1)

          # Marcar como processado
          video_atual['processado'] = True
          video_atual['data_processamento'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

          # Salvar lista atualizada
          with open('videos-lista.json', 'w', encoding='utf-8') as f:
              json.dump(videos, f, indent=2, ensure_ascii=False)

          print("\n‚úÖ Processamento conclu√≠do!")
          print(f"üìä V√≠deos restantes: {sum(1 for v in videos if not v.get('processado', False))}")
          EOF
      
      - name: Commit da lista atualizada
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "Flashback Bot"
          git add videos-lista.json
          git diff --staged --quiet || git commit -m "‚úÖ V√≠deo processado - $(date '+%Y-%m-%d %H:%M')"
          git push
      
      - name: Notificar sucesso
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="‚úÖ Bot 2 - V√≠deo Processado!

          üé¨ Novo v√≠deo enviado com sucesso
          üìÖ $(date '+%d/%m/%Y %H:%M')
          
          üîÑ Pr√≥ximo v√≠deo ser√° processado amanh√£ √†s 12h"
      
      - name: Notificar erro
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="‚ùå Erro no processamento!

          üìÖ $(date '+%d/%m/%Y %H:%M')
          
          üîç Verifique os logs: https://github.com/${{ github.repository }}/actions"
